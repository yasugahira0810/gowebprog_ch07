# 第７章 GoによるWebサービスの作成-XMLおよびJSONの生成と解析

## はじめに

- *このリポジトリは[[秋葉原] Goプログラミング実践入門 輪読会 (初心者歓迎！)](https://weeyble-go.connpass.com/event/172045/)の発表資料として用意したリポジトリです。*
- *書籍の要約は正体、担当者の理解で書いているところは斜体で記載しています*
- *権利関係で問題があればご指摘ください*

## アジェンダ

| 節                                | 概要                                                         | 輪読会での説明方針                                         |
| --------------------------------- | ------------------------------------------------------------ | ---------------------------------------------------------- |
| 7.1 Webサービス入門               | - 本章におけるWebサービスの定義<br />- 本章で説明の中心となるSOAP/RESTといったアーキテクチャ・デザイン手法やXML/JSONといったデータフォーマットに関する概要の説明 | Go出てこないからさらっと説明                               |
| 7.2 SOAPベースのWebサービスの基本 | - SOAPの基本的な説明<br />- 本章だとこの後SOAPの話は出てこない | Go出てこないしSOAPの話はその後出てこないから超さらっと説明 |
| 7.3 RESTベースのWebサービスの基本 | - RESTの基本的な説明                                         | Go出てこないからさらっと説明                               |
| 7.4 Go言語によるXMLの解析と生成   | - 7.4.1でXMLの解析について説明し、7.4.2でXMLの生成について説明<br />- 7.4.1では小さなXMLファイルが用途のxml.Unmarshalと、ストリーム処理や大きなXMLが用途のxml.Decoderを説明<br />- 7.4.2ではその逆の働きをするxml.Marshal(xml.MarshalIndent)とxml.Encoderを使って、XMLの生成について説明<br />- 7.4.1をやれば、7章全体の半分以上はやったといっても過言ではないと思う。 | コードを見ながらしっかり説明                               |
| 7.5 Go言語によるJSONの解析と生成  | - 基本XMLの説明と同じ                                        | さらっと説明                                               |
| 7.6 Go Webサービスの作成          |                                                              |                                                            |
| 7.7 まとめ                        |                                                              |                                                            |



## 7.1 Webサービス入門

- エンドユーザが人間だとWebアプリ、エンドユーザがソフトウェアだとWebサービス*（この定義って一般的ですか？個人的には違和感があるのですが。。。）*
- Go言語の用途の１つとしてWebサービスの作成が挙げられる
- WebサービスにはSOAPベース、RESTベース、XML-RPCベースなど様々ある
- *以下の引用の通り、適材適所での使い分けが大切と思われる*

```
開発者や企業がSOAPベースとRESTベースのWebサービスを別の目的のために同時に採用することもよくあります。その場合、SOAPは企業内部を統合するための社内用アプリケーションに使われ、RESTは外部のサードパーティの開発者向けに使われます。この方式を採用すれば、双方の強み（RESTの高速性とシンプルさ、SOAPのセキュリティと堅牢性）を効果的に利用することができます。
```

- *昨今だとSOAPは聞かなくなったように思うが、マイクロサービスの文脈ではgRPCを聞くようになった。「サービス間の通信にはgRPCを使って、外向けにはREST APIを公開する」といった使い分けをよく聞くので、やっぱり大切なのは適材適所での使い分けなのかと思っている。*
- *[fukabori.fm ep29. 技術選定の審美眼(2) w/ twada](https://fukabori.fm/episode/29)では、技術は螺旋のように進化する、と言う話の中でSOAPやREST, XMLやJSONの話が出てきて面白かったです。*

## 7.2 SOAPベースのWebサービスの基本

- SOAPはXMLで定義された構造化データを交換するためのプロトコル
- Simple Object Access Protocolの略だけど複雑になってしまっている

## 7.3 RESTベースのWebサービスの基本

- RESTはOOPの考え方の延長線上に進化したもの

- 関数を公開してサービスとして呼び出すのではなく、「リソース」と呼ばれるモデルを公開して、それに対して少数のアクション（「動詞」）を許可する

- 利用可能なHTTPメソッドの範囲に機能が制限されるので、`ACTIVATE /user/456 HTTP/1.1`のようなリクエストは送れない。よく使われる回避策を２つ挙げる。

  - アクションをリソースに変える

    ```
    POST /user/456/activation HTTP/1.1
    {"date": "20150515T13:05:05Z"}
    ```

  - アクションをリソースの属性にする

    ```
    PATCH /user/456 HTTP/1.1
    {"active": "true"}
    ```

## 7.4 Go言語によるXMLの解析と生成

- ライブラリencoding/xmlを使う

### 7.4.1 XMLの解析

**xml.Unmarshalを用いたXMLの解析（小さなXMLファイル向け）**

- 手順は以下の通り（本文から引用）

```
１．XMLデータを格納するための構造体を作成する。
２．xml.Unmarshalを使ってXMLデータを内部構造に従って構造体に格納（unmarshal）する
```

- *XML化するのがMarshalかUnmarshalかわからなくなってしまったので図示した。Goの世界から見たときに、XML化するのがMarshal, XMLをGoの世界に持ってくるのがUnmarshal。*

![xmlUnmarshal](figures/xmlUnmarshal.png)

```go
		switch se := t.(type) { // 型アサーション
```

- 変数tはinterface{}型の変数
- typeは型名

## 7.5 Go言語によるJSONの解析と生成

## 7.6 Go Webサービスの作成

## 7.7 まとめ